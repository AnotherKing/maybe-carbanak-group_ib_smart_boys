
Схема обмена платежами КБ с ЦБ через АРМ КБР или аналогичный софт следующая:
1) АБС генерирует xml файл с платежами по команде оператора
2) Данный файл перемещается на машину с АРМ КБР, где выполняется его проверка (валидация полей, контроль нумерации документов и пр.) и подписание. В зависимости от политики КБ, для подписания может требоваться действие оператора (просмотр количества и общей суммы платежей, сверка с реестром в АБС, нажатие кнопки "Подтвердить"), либо подписание может выполняться автоматически (для большого объема платежей). В некоторых случаях может требоваться подтверждение более чем 1 оператора (подпись контролера после подписи оператора), тогда файл после 1 подписи перемещается на другой АРМ КБР и обрабатывается там.
3) Подписанный и закодированный файл перемещается в транспортный шлюз (Астра или УТА). Зачастую для отправки требуется определенное действие оператора - запуск связи, перемещение файла между папками, и т.д. В редких случаях отправка выполняется вручную путем загрузки на веб-сайт ЦБ через защищенный канал связи.
4) После отправки из транспортного шлюза практически сразу приходят сначала транспортные квитанции, а затем отчеты о подтверждении выполнения (ED205) или помещении в очередь отложенных (ED206). 
5) Входящие документы обрабатываются АРМ КБР - расшифровываются, и передаются в АБС
6) АБС импортирует ответы от ЦБ и присваивает соответствующие статусы платежам. Если приходят ответные статутсы на несуществующие (незарегистрированные) платежи, АБС создает их автоматически с соответствующими пометками, что приводит к необычным ощущениям у персонала отдела корреспондентских отношений.

В общих чертах для отправки своего платежа через АРМ КБР и ЦБ необходимо:
1) Найти связанные с обменом с ЦБ машины - АРМ(ы) КБР по ключевому процессу uarm.exe и шлюз отправки типа Астра (AstraC.exe) или UTA (Program Files\Bank of Russia\UTA)
2) В крупных банках один или оба компонента могут отсутствовать, а их роль выполнять специализированное ПО. Либо место установки может быть не видно явно. В таких случаях необходимо исследовать АБС (RS-Bank, Diasoft и пр.), файл-серверы, чтобы выяснить, каким образом идет обмен платежными файлами.
3) Из АРМ КБР слить логи (uarm\log\папки с датой) за последние 7-14 дней. На основе логов выяснить время включения-выключения, периодичность рейсов, настройки обмена файлами. В зависимость от настроек, АРМ КБР может выполнять подписание файлов автоматически по его появлению в определенных папках, либо может требоваться определенное вмешательство оператора (или иного лица другим способом) для перемещения файла в нужную папку.

Для определения настроек АРМ КБР смотрим в начало файла лога
ИнициализацияРежим работы - 'Комбинированный', тип клиента - 'Кредитная организация'
Режим работы может быть Автоматический шлюз (никакого вмешательства не требуется, файл подписывается полностью автоматически), Комбинированный - часто требуется "подтверждение" от оператора, либо Ручной - когда каждое действие (перенос файла между папками) выполняется вручную по команде оператора.

Также интерес представляет следующая строка
Формирование КАПараметры инициализации: 'Вкл для О:Вал=True:Стр=True:Мон=True', 'C:\uarm3\exg\opr', 'C:\uarm3\exg\ret'- True, 'C:\uarm3\exg\ret'- False, 'OverwriteOut'- True 
Данная конфигурация говорит о том, что файл, помещенный в 'C:\uarm3\exg\opr' будет автоматически подписан (стоит значение True) и перемещен в папку 'C:\uarm3\exg\ret'- True

Если проанализировать лог отправки платежа
Входной контрольНачало обработки файла M:\MCI\OUT\reestr010101.xml
Входной контрольВходной файл reestr010101.xml перемещён в: C:\uarm3\exg\opr\reestr010101.xml
Входной контрольЗавершение обработки файла reestr010101.xml
Формирование КАНачало обработки файла C:\uarm3\exg\opr\reestr010101.xml
Формирование КАВходной файл reestr010101.xml перемещён в: C:\uarm3\exg\ret\reestr010101.xml
Формирование КАЗавершение обработки файла reestr010101.xml
Отправка сообщенийНачало обработки файла C:\uarm3\exg\ret\reestr010101.xml
Отправка сообщенийВходной файл reestr010101.xml перемещён в: m:\ASTRA\MCO\MCO_OK\reestr010101.xml
Отправка сообщенийЗавершение обработки файла reestr010101.xml

то видно, что появившийся на сетевом диске (файл-сервере) реестр платежей в папке M:\MCI\OUT\ был автоматически обнаружен АРМ КБР, выполнена его валидация (входной контроль) и он был скопирован в локальную папку C:\uarm3\exg\opr\reestr010101.xml 
Эта же папка является входной для подписания (формирование КА, кода аутентификации), поэтому далее было выполнено автоматическое подписание файла и его перемещение на сетевой диск для дальнейшего использования транспортом. 
Однако часто выходная папка входного контроля и входная папка формирования КА различаются, что предполагает, что оператор проверит реестр платежей вручную и даст команду "Подтвердить", что заставит АРМ КБР переместить файл во входную папку формирования КА.
Данный шаг можно пропустить, если копировать подготовленный файл с платежами сразу во входную папку для формирования КА, которую видно в начале лога в сообщении Формирование КАПараметры инициализации.
Также зачастую выходной файл после подписи необходимо вручную перенести в транспортный шлюз - некоторую папку, из которой автоматически, по расписанию или по команде оператора осуществляется отправка файлов в ЦБ. Входная папка у транспорта уточняется на основе его логов и конфигурации.
Для УТА это два файла базы данных в папке Program Files\Bank of Russia\UTA, для Астры - .log файлы в папке где лежит AstraC.exe

4) Продумать мероприятия по недопущению ответов от ЦБ на отправленный платеж в АБС. Это может быть модификация скриптов обмена файлов, выведение из строя серверов АБС, служб обработки файлов (например, xml blaster для diasoft) и пр.


Приложенные скрипты

gen_payments_script - php-скрипт генерации xml реестра платежей
В файле gen1.php редактируются различные настройки, связанные с реквизитами, как в начале (конфигурации), так и по тексту, в местах генерации заголовков ED101 и внешнего конверта.
В папку src_accs помещаются xml-исходящие платежи из АРМ КБР (папка exch\inp или распакованное из stg\arch\inp), из них делается выборка по отправителям, специфичным для данного банка.
В curday_inp непосредственно перед генерацией и использованием помещаются все исходящие платежи из КБР за текущий день. В этих файлах анализируется значение EdNo, чтобы обеспечить наличие сквозной либо как минимум не перекрывающейся нумерации отдельных платежей, которая контролируется в кбр, шлюзе и на стороне ЦБ.
В t_accs помещаются текстовые файлы по типовому формату с данными карт и лимитов для переводов. 


bck_logs - php-скрипт оценки балансов корсчета на основе бекап-файлов из uarm\bck.
подпапки с датами из uarm\bck копируются в bck_logs, при запуске скрипт выдает диапазоны балансов за сутки по найденным датам.